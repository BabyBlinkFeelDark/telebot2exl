# Бот для экспорта данных о курьерах

Этот проект реализует Telegram-бота, который позволяет авторизованным пользователям генерировать и скачивать отчеты о работе курьеров, извлекаемые из базы данных PostgreSQL. Бот поддерживает экспорт данных в файлы Excel с фильтрацией по указанному временному диапазону.

## Возможности

- **Авторизация**: Только авторизованные пользователи могут получить доступ к определенным функциям бота.
- **Экспорт данных**: Экспортирует данные о курьерах (например, количество доставок, среднее время ожидания) в файл Excel.
- **Форматирование Excel файла**: Автоматически форматирует экспортированный файл Excel для лучшей читаемости.
- **Фоновая задача**: Бот может выполнять запланированные задачи, такие как очистка временных таблиц, в фоновом режиме.
- **Переменные окружения**: Конфигурация бота осуществляется через переменные окружения с использованием пакета `dotenv`.

## Требования

- Python 3.8+
- База данных PostgreSQL
- Токен Telegram-бота (полученный от [BotFather](https://core.telegram.org/bots#botfather))
- Переменные окружения для конфигурации базы данных и токена Telegram-бота.

## Установка

### 1. Клонирование репозитория
Клонируйте репозиторий на ваш локальный компьютер:

```bash
git clone https://github.com/BabyBlinkFeelDark/telebot2exl.git
cd telebot2exl
```

### 2. Установка зависимостей
Установите необходимые Python-пакеты:

```bash
pip install -r requirements.txt
```

### 3. Настройка переменных окружения
Создайте файл `.env` в корневой директории и добавьте в него следующие переменные:

```env
HOST=your_database_host
PORT=your_database_port
USER_NAME=your_database_username
PASSWORD=your_database_password
DBNAME=your_database_name
LOGIN_USER=your_telegram_bot_login
LOGIN_PASSWORD=your_telegram_bot_password
TOKEN=your_telegram_bot_token
```

Замените значения на ваши актуальные данные для базы данных и Telegram-бота.

### 4. Настройка базы данных PostgreSQL
Убедитесь, что ваша база данных PostgreSQL работает и доступна. Бот ожидает, что в базе данных будут как минимум две таблицы:

- **couriers**: Содержит информацию о курьерах (например, `courier_id`, `courier_name`).
- **orders**: Содержит информацию о заказах (например, `order_id`, `courier_id`, `cur_time`, `time_taken`).

Бот будет выполнять SQL-запрос для извлечения данных, связанных с доставками курьеров и их показателями.

### 5. Запуск бота
Запустите бота с помощью следующей команды:

```bash
python main.py
```

Бот начнет работу и будет ожидать команд в указанном Telegram-чате.

## Команды

- `/start`: Начинает разговор и отправляет приветственное сообщение.
- `/login`: Запрашивает логин и пароль для авторизации. Только авторизованные пользователи могут использовать команду `/export`.
- `/export`: Инициирует процесс генерации Excel-отчета по курьерам за указанный временной диапазон.

### Процесс экспорта
После ввода команды `/export`:
1. Бот запросит временной диапазон в формате `st_p-end_p` (например, `14-17`).
2. После указания диапазона бот сгенерирует файл Excel с данными о курьерах и отправит его пользователю.

В Excel файле будет содержаться:
- **ФИО курьера (Courier Name)**
- **Количество доставок (Number of Deliveries)**
- **Общее время ожидания (Total Waiting Time)**
- **Среднее время ожидания (Average Waiting Time)**

### Команда отмены
Если вы хотите отменить процесс на любом этапе, используйте команду `/cancel`.

## Запланированные задачи

Бот также настроен на выполнение фоновых задач с использованием библиотеки `APScheduler`. Например, он может периодически очищать временные таблицы или выполнять другие операции по расписанию.

## Логирование

Для логирования бот использует модуль `logging` из Python. Важные события, такие как взаимодействие с пользователями, попытки авторизации и ошибки, записываются в файл `bot.log`.

## Структура файлов

```
courier-data-export-bot/
│
├── data/                    # Директория для хранения экспортированных Excel файлов
├── src/
│   ├── bot_db.py            # Функции для работы с базой данных и экспорта данных
│   ├── export.py            # Функции для экспорта данных в Excel
│   └── g_collector.py       # Фоновые задачи (например, очистка таблиц)
├── .env                     # Переменные окружения
├── bot.log                  # Лог-файл
├── main.py                  # Главный файл для запуска бота
├── requirements.txt         # Список зависимостей Python
└── README.md                # Этот файл
```

## Ошибки и устранение неполадок

- Убедитесь, что ваша база данных работает и доступна.
- Проверьте правильность настроек переменных окружения, особенно настройки для подключения к базе данных.
- Если бот не отвечает или выдает ошибки, проверьте файл `bot.log` для получения подробных логов.

## Лицензия

Этот проект лицензирован по лицензии MIT — см. файл [LICENSE](LICENSE) для подробностей.
